# QA Agent - Quality Assurance System

## Overview

The QA Agent is an AI-powered quality assurance system that monitors and validates prompts generated by the main content generation agent. It ensures prompts meet quality standards, follow rules, and are compatible with the selected AI model.

## Purpose

1. **Quality Control**: Validate prompt quality before generation
2. **Rule Compliance**: Ensure prompts follow agent-specific rules
3. **Model Compatibility**: Check if prompts suit the selected model
4. **Feedback Integration**: Verify that user feedback is properly applied
5. **Learning Aid**: Identify common issues and improvement areas

## How It Works

### Validation Flow

```
User Request
    ‚Üì
Main Agent generates prompt
    ‚Üì
[Optional] QA Agent validates prompt
    ‚Üì
    ‚îú‚îÄ Approved (Score 70-100) ‚Üí Generate content
    ‚îú‚îÄ Needs Revision (Score 50-69) ‚Üí Generate with warning
    ‚îî‚îÄ Rejected (Score 0-49) ‚Üí Skip generation, report issues
```

### Validation Modes

#### 1. Full Validation (`POST /api/qa/validate`)
- Uses GPT-4o for comprehensive analysis
- Considers recent user feedback
- Checks model compatibility
- Provides detailed feedback and suggestions
- Response format: JSON with status, score, issues, strengths

#### 2. Quick Validation (`POST /api/qa/quick-validate`)
- Fast rule-based checks
- No AI calls (instant)
- Good for real-time validation
- Basic compatibility checks
- Useful for batch operations

## Agent-Specific Rules

### Dating Agent Rules

‚úÖ **Required Elements**:
- Smartphone filename (IMG_####.HEIC, DSC_####.JPG, etc.)
- Device specification (iPhone 13/14 Pro, Pixel 7, Samsung S21)
- 1-3 authentic imperfections
- Natural language (no technical jargon)

‚ùå **Forbidden Elements**:
- Technical photography terms (aperture, bokeh, diffusion, f-stop)
- Perfect/overly polished descriptions
- Generic AI-looking prompts

üìã **11-Parameter System**:
1. Smartphone photo style
2. Subject
3. Composition
4. Background
5. Lighting
6. Color palette
7. Mood & atmosphere
8. Motion & dynamics
9. Depth & focus
10. Texture & detail
11. Time & weather

üîç **Model Compatibility**:
- **Seedream 4**: ‚úÖ Perfect for smartphone realism
- **Nano Banana Pro**: ‚úÖ Good, supports realistic photos
- **FLUX models**: ‚ö†Ô∏è May struggle with filename/device authenticity
- **SDXL**: ‚ö†Ô∏è Less suitable for ultra-realistic smartphone feel

### General Agent Rules

‚úÖ **Required Elements**:
- Detailed, specific description
- Logically consistent parameters
- Category-appropriate details
- Creative but relevant content

‚ùå **Common Issues**:
- Contradictory parameters (e.g., "dark scene" + "bright sunlight")
- Generic descriptions
- Missing key details
- Overly complex/confusing prompts

üîç **Model Compatibility**:
- **Seedream 4**: Good for realistic content
- **Nano Banana Pro**: Excellent for detailed, legible text
- **FLUX Schnell**: Fast, general purpose
- **FLUX Dev**: High detail, complex scenes
- **SDXL**: Artistic, stylized content

## Integration

### Enable QA in Generation Request

```javascript
POST /api/generation/generate
{
  "sessionId": "...",
  "projectId": "...",
  "userId": "...",
  "userPrompt": "Beautiful woman on beach",
  "count": 10,
  "model": "seedream-4",
  "enableQA": true  // ‚Üê Enable QA validation
}
```

### Response with QA Results

Each generated item includes QA validation results:

```json
{
  "success": true,
  "content": {
    "id": "...",
    "enhanced_prompt": "...",
    "qa_validation": {
      "validated": true,
      "score": 85,
      "status": "approved",
      "issues": [],
      "timestamp": "2025-12-01T..."
    }
  }
}
```

### Manual QA Check

You can validate a prompt manually before generation:

```javascript
POST /api/qa/validate
{
  "userPrompt": "Woman on beach",
  "enhancedPrompt": "Smartphone photo of woman...",
  "selectedParams": { ... },
  "agentType": "dating",
  "model": "seedream-4",
  "category": "dating",
  "sessionId": "..." // Optional, for loading recent comments
}
```

Response:

```json
{
  "success": true,
  "data": {
    "validation": {
      "status": "approved",
      "score": 85,
      "issues": [
        {
          "type": "minor",
          "severity": "minor",
          "message": "Consider adding more lighting details",
          "suggestion": "Specify lighting direction and quality"
        }
      ],
      "strengths": [
        "Includes smartphone filename",
        "Has authentic imperfections",
        "Natural language used"
      ],
      "modelCompatibility": {
        "compatible": true,
        "reason": "Seedream 4 excels at smartphone realism",
        "suggestions": []
      },
      "feedbackUsage": {
        "commentsUsed": true,
        "weightsApplied": true,
        "userPreferencesConsidered": true
      },
      "overallFeedback": "Strong prompt with authentic smartphone feel..."
    }
  }
}
```

## Validation Scores

| Score Range | Status | Meaning |
|------------|--------|---------|
| 90-100 | ‚≠ê Excellent | Perfect, no issues |
| 70-89 | ‚úÖ Approved | Good, minor issues |
| 50-69 | ‚ö†Ô∏è Needs Revision | Acceptable, but has issues |
| 0-49 | ‚ùå Rejected | Poor quality, skip generation |

## Common Issues & Solutions

### Dating Agent

**Issue**: Missing smartphone filename
```
‚ùå "Beautiful woman on beach at sunset"
‚úÖ "Smartphone photo of beautiful woman on beach at sunset, IMG_4527.HEIC, iPhone 14 Pro"
```

**Issue**: Technical jargon detected
```
‚ùå "f/1.8 aperture, bokeh effect, diffusion lighting"
‚úÖ "Slightly blurred background, natural soft lighting, casual photo feel"
```

**Issue**: Too perfect
```
‚ùå "Perfect composition, professional lighting, flawless execution"
‚úÖ "Slightly off-center, casual angle, tiny bit of motion blur, natural lighting"
```

### General Agent

**Issue**: Contradictory parameters
```
‚ùå "Dark moody scene with bright daylight sunlight"
‚úÖ "Dark moody scene with dim street lighting at dusk"
```

**Issue**: Too generic
```
‚ùå "A car on a road"
‚úÖ "Red sports car on winding mountain road at sunset, motion blur, dramatic cliffside view"
```

## Future Enhancements

### Planned Features

1. **Automatic Retry**: If QA rejects, automatically regenerate prompt
2. **Learning System**: QA agent learns from successful vs. failed generations
3. **Custom Rules**: Allow users to define custom validation rules
4. **QA Dashboard**: View QA statistics and common issues
5. **Model-Specific Fine-Tuning**: Optimize validation per model

### Database Schema

For full QA tracking, add a `qa_validations` table:

```sql
CREATE TABLE qa_validations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  content_id UUID REFERENCES content_v3(id),
  session_id UUID REFERENCES sessions(id),
  
  user_prompt TEXT,
  enhanced_prompt TEXT,
  agent_type VARCHAR(50),
  model VARCHAR(50),
  
  status VARCHAR(50), -- approved, needs_revision, rejected
  score INTEGER, -- 0-100
  issues JSONB,
  strengths TEXT[],
  
  model_compatibility JSONB,
  feedback_usage JSONB,
  overall_feedback TEXT,
  
  validated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## API Reference

### Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/qa/validate` | POST | Full AI-powered validation |
| `/api/qa/quick-validate` | POST | Fast rule-based validation |
| `/api/qa/stats` | GET | Get QA statistics for a session |

### Parameters

**Full Validation**:
- `userPrompt` (required): Original user request
- `enhancedPrompt` (required): Agent-generated prompt
- `selectedParams`: Parameters used
- `agentType` (required): 'dating' or 'general'
- `model` (required): Model to be used
- `category`: Content category
- `sessionId`: For loading recent comments

**Quick Validation**:
- `enhancedPrompt` (required): Prompt to validate
- `agentType` (required): 'dating' or 'general'
- `model` (required): Model to be used

## Best Practices

1. **Enable for Production**: Use QA in production to maintain quality
2. **Monitor Scores**: Track average QA scores over time
3. **Review Rejected Prompts**: Learn from failed validations
4. **Adjust Rules**: Fine-tune validation rules based on results
5. **Balance Speed vs. Quality**: Use quick validation for large batches
6. **User Feedback Loop**: Use QA feedback to improve main agent

## Troubleshooting

**QA validation is too strict**:
- Adjust severity thresholds in `qa-agent.service.js`
- Use quick validation instead of full validation

**QA validation is too lenient**:
- Add more validation rules
- Increase minimum score threshold

**QA validation is slow**:
- Use quick validation for real-time checks
- Run full validation asynchronously
- Enable QA only for first item in batch

---

**Last Updated**: 2025-12-01  
**Version**: 1.0.0  
**Status**: Production Ready
